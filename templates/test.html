<!DOCTYPE html>
<html>
<head>
    <title>ê°•ì˜ ì²˜ë¦¬ ì„œë²„ í…ŒìŠ¤íŠ¸</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        h1 {
            color: #2c3e50;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
            margin-top: 30px;
        }
        input, button {
            padding: 8px 12px;
            margin: 5px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        button {
            background-color: #3498db;
            color: white;
            cursor: pointer;
            border: none;
        }
        button:hover {
            background-color: #2980b9;
        }
        pre {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
        }
        .task-card {
            border: 1px solid #ddd;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            background-color: #f9f9f9;
        }
        .success { color: green; }
        .error { color: red; }
        .warning { color: orange; }
        .progress-bar {
            height: 20px;
            background-color: #e0e0e0;
            border-radius: 4px;
            margin: 10px 0;
        }
        .progress-bar-fill {
            height: 100%;
            background-color: #3498db;
            border-radius: 4px;
            text-align: center;
            color: white;
            line-height: 20px;
            transition: width 0.3s ease;
        }
        .multiple-files-container {
            border: 2px dashed #ccc;
            padding: 20px;
            text-align: center;
            margin: 10px 0;
            cursor: pointer;
        }
        .file-list {
            margin: 10px 0;
            max-height: 200px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <h1>ğŸ¬ URL ì²˜ë¦¬ í…ŒìŠ¤íŠ¸</h1>
    <form id="urlForm">
        <input type="text" id="url" placeholder="ìœ íŠœë¸Œ URL ì…ë ¥" required style="width: 70%;">
        <button type="submit">URL ì²˜ë¦¬</button>
    </form>
    <pre id="urlResult"></pre>

    <h1>ğŸ“ ë‹¨ì¼ íŒŒì¼ ì—…ë¡œë“œ</h1>
    <form id="fileForm">
        <input type="file" id="file" accept=".mp4,.avi,.mov,.mkv,.webm,.mp3,.wav,.flac,.m4a" required>
        <button type="submit">íŒŒì¼ ì—…ë¡œë“œ</button>
    </form>
    <pre id="fileResult"></pre>

    <h1>ğŸ“¦ ë‹¤ì¤‘ íŒŒì¼ ì—…ë¡œë“œ</h1>
    <div class="multiple-files-container" id="dropZone">
        <p>íŒŒì¼ì„ ì—¬ê¸°ì— ë“œë˜ê·¸í•˜ê±°ë‚˜ í´ë¦­í•˜ì—¬ ì„ íƒí•˜ì„¸ìš”</p>
        <input type="file" id="multipleFiles" multiple accept=".mp4,.avi,.mov,.mkv,.webm,.mp3,.wav,.flac,.m4a" style="display: none;">
    </div>
    <div class="file-list" id="fileList"></div>
    <button id="uploadMultiple" disabled>ì„ íƒí•œ íŒŒì¼ ì—…ë¡œë“œ</button>
    <pre id="multipleResult"></pre>

    <h1>ğŸ“Š ì§„í–‰ ìƒí™© ê´€ë¦¬</h1>
    <input type="text" id="taskId" placeholder="task_id ì…ë ¥" style="width: 50%;">
    <button id="checkProgress">ì§„í–‰ ìƒí™© í™•ì¸</button>
    <button id="checkAllProgress">ì „ì²´ ì‘ì—… í™•ì¸</button>
    <button id="cancelTask">ì‘ì—… ì·¨ì†Œ</button>
    <div id="progressDisplay"></div>
    <pre id="progressResult"></pre>

    <h1>ğŸ“¥ ê²°ê³¼ ë‹¤ìš´ë¡œë“œ</h1>
    <div id="downloadButtons" style="display: none;">
        <button id="downloadAudio">ì˜¤ë””ì˜¤ ë‹¤ìš´ë¡œë“œ</button>
        <button id="downloadResult">ê²°ê³¼ íŒŒì¼ ë‹¤ìš´ë¡œë“œ</button>
    </div>
    
    <div id="tasksContainer">
        <!-- í™œì„± ì‘ì—… ì¹´ë“œê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
    </div>

    <script>
        // ì„œë²„ ê¸°ë³¸ URL (í•„ìš”ì‹œ ë³€ê²½)
        const API_BASE_URL = 'http://localhost:5000';
        
        // í™œì„± ì‘ì—… ëª©ë¡ ë° ìë™ ì—…ë°ì´íŠ¸ ê´€ë ¨
        let activeTasks = {};
        let updateInterval = null;
        
        // ê¸°ë³¸ API í˜¸ì¶œ í•¨ìˆ˜
        async function fetchData(url, options, resultElement) {
            try {
                const response = await fetch(url, options);
                const data = await response.json();
                
                if (resultElement) {
                    resultElement.innerText = JSON.stringify(data, null, 2);
                }
                
                // task_id ìë™ ì…ë ¥
                if (data.task_id) {
                    document.getElementById('taskId').value = data.task_id;
                    
                    // ì‘ì—… ëª©ë¡ì— ì¶”ê°€
                    addToActiveTasks(data.task_id);
                    
                    // ìë™ ì—…ë°ì´íŠ¸ ì‹œì‘
                    startAutoUpdate();
                }
                
                return data;
            } catch (error) {
                if (resultElement) {
                    resultElement.innerText = `âš  ì˜¤ë¥˜ ë°œìƒ: ${error.message}`;
                }
                console.error('API í˜¸ì¶œ ì˜¤ë¥˜:', error);
                return null;
            }
        }
        
        // URL ì œì¶œ ì²˜ë¦¬
        document.getElementById('urlForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const url = document.getElementById('url').value;
            await fetchData(`${API_BASE_URL}/process/url`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ url })
            }, document.getElementById('urlResult'));
        });

        // ë‹¨ì¼ íŒŒì¼ ì—…ë¡œë“œ ì²˜ë¦¬
        document.getElementById('fileForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const file = document.getElementById('file').files[0];
            const formData = new FormData();
            formData.append('file', file);
            await fetchData(`${API_BASE_URL}/process/file`, {
                method: 'POST',
                body: formData
            }, document.getElementById('fileResult'));
        });
        
        // ë“œë˜ê·¸ ì•¤ ë“œë¡­ ì˜ì—­ ì„¤ì •
        const dropZone = document.getElementById('dropZone');
        const multipleFiles = document.getElementById('multipleFiles');
        const fileList = document.getElementById('fileList');
        const uploadButton = document.getElementById('uploadMultiple');
        
        // í´ë¦­ìœ¼ë¡œ íŒŒì¼ ì„ íƒ
        dropZone.addEventListener('click', () => {
            multipleFiles.click();
        });
        
        // ë“œë˜ê·¸ ì•¤ ë“œë¡­ ì´ë²¤íŠ¸
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.style.borderColor = '#3498db';
        });
        
        dropZone.addEventListener('dragleave', () => {
            dropZone.style.borderColor = '#ccc';
        });
        
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.style.borderColor = '#ccc';
            
            if (e.dataTransfer.files.length > 0) {
                multipleFiles.files = e.dataTransfer.files;
                updateFileList();
            }
        });
        
        // íŒŒì¼ ì„ íƒ ì‹œ ëª©ë¡ ì—…ë°ì´íŠ¸
        multipleFiles.addEventListener('change', updateFileList);
        
        function updateFileList() {
            fileList.innerHTML = '';
            uploadButton.disabled = multipleFiles.files.length === 0;
            
            Array.from(multipleFiles.files).forEach(file => {
                const fileItem = document.createElement('div');
                fileItem.textContent = `${file.name} (${formatFileSize(file.size)})`;
                fileList.appendChild(fileItem);
            });
        }
        
        // íŒŒì¼ í¬ê¸° í¬ë§·íŒ…
        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            else if (bytes < 1048576) return (bytes / 1024).toFixed(1) + ' KB';
            else if (bytes < 1073741824) return (bytes / 1048576).toFixed(1) + ' MB';
            else return (bytes / 1073741824).toFixed(1) + ' GB';
        }
        
        // ë‹¤ì¤‘ íŒŒì¼ ì—…ë¡œë“œ
        document.getElementById('uploadMultiple').addEventListener('click', async () => {
            const files = multipleFiles.files;
            if (files.length === 0) return;
            
            const formData = new FormData();
            Array.from(files).forEach(file => {
                formData.append('files[]', file);
            });
            
            const result = await fetchData(`${API_BASE_URL}/process/batch`, {
                method: 'POST',
                body: formData
            }, document.getElementById('multipleResult'));
            
            // ì‘ì—… IDë“¤ì„ í™œì„± ì‘ì—… ëª©ë¡ì— ì¶”ê°€
            if (result && result.results) {
                result.results.forEach(item => {
                    if (item.task_id) {
                        addToActiveTasks(item.task_id);
                    }
                });
                startAutoUpdate();
            }
            
            // íŒŒì¼ ëª©ë¡ ì´ˆê¸°í™”
            multipleFiles.value = '';
            updateFileList();
        });

        // ì§„í–‰ ìƒí™© í™•ì¸
        document.getElementById('checkProgress').addEventListener('click', async () => {
            const taskId = document.getElementById('taskId').value;
            if (!taskId) {
                document.getElementById('progressResult').innerText = "âš  task_idë¥¼ ì…ë ¥í•˜ì„¸ìš”!";
                return;
            }
            
            const data = await fetchData(`${API_BASE_URL}/progress/${taskId}`, {}, document.getElementById('progressResult'));
            updateProgressDisplay(taskId, data);
        });
        
        // ì „ì²´ ì‘ì—… í™•ì¸
        document.getElementById('checkAllProgress').addEventListener('click', async () => {
            const data = await fetchData(`${API_BASE_URL}/progress/all`, {}, document.getElementById('progressResult'));
            
            // ëª¨ë“  ì‘ì—…ì„ activeTasksì— ì¶”ê°€
            if (data) {
                Object.keys(data).forEach(taskId => {
                    addToActiveTasks(taskId, data[taskId]);
                });
                updateAllTaskCards();
            }
        });

        // ì‘ì—… ì·¨ì†Œ
        document.getElementById('cancelTask').addEventListener('click', async () => {
            const taskId = document.getElementById('taskId').value;
            if (!taskId) {
                document.getElementById('progressResult').innerText = "âš  task_idë¥¼ ì…ë ¥í•˜ì„¸ìš”!";
                return;
            }
            await fetchData(`${API_BASE_URL}/cancel/${taskId}`, {
                method: 'POST'
            }, document.getElementById('progressResult'));
            
            // ì‘ì—… ì¹´ë“œ ì—…ë°ì´íŠ¸
            updateTaskState(taskId, { status: "cancelled", message: "ì‚¬ìš©ìì— ì˜í•´ ì·¨ì†Œë¨" });
        });

        // ê²°ê³¼ ë‹¤ìš´ë¡œë“œ ë²„íŠ¼
        document.getElementById('downloadAudio').addEventListener('click', () => {
            const taskId = document.getElementById('taskId').value;
            if (!taskId) return;
            window.location.href = `${API_BASE_URL}/download/audio/${taskId}`;
        });

        document.getElementById('downloadResult').addEventListener('click', () => {
            const taskId = document.getElementById('taskId').value;
            if (!taskId) return;
            window.location.href = `${API_BASE_URL}/download/result/${taskId}`;
        });
        
        // ì§„í–‰ ìƒí™© í‘œì‹œ ì—…ë°ì´íŠ¸
        function updateProgressDisplay(taskId, data) {
            const progressDisplay = document.getElementById('progressDisplay');
            const downloadButtons = document.getElementById('downloadButtons');
            
            if (!data) {
                progressDisplay.innerHTML = `<p class="error">ì‘ì—… ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>`;
                downloadButtons.style.display = "none";
                return;
            }
            
            let statusClass = 'warning';
            if (data.status === "completed") statusClass = 'success';
            if (data.status === "failed" || data.status === "cancelled") statusClass = 'error';
            
            let html = `
                <h3>ì‘ì—… ID: ${taskId}</h3>
                <p>ìƒíƒœ: <span class="${statusClass}">${data.status}</span></p>
                <p>ë©”ì‹œì§€: ${data.message || 'ì •ë³´ ì—†ìŒ'}</p>
            `;
            
            if (data.progress !== undefined) {
                html += `
                    <div class="progress-bar">
                        <div class="progress-bar-fill" style="width: ${data.progress}%">${data.progress}%</div>
                    </div>
                `;
            }
            
            progressDisplay.innerHTML = html;
            
            // ì‘ì—…ì´ ì™„ë£Œë˜ë©´ ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ í‘œì‹œ
            if (data.status === "completed") {
                downloadButtons.style.display = "block";
            } else {
                downloadButtons.style.display = "none";
            }
        }
        
        // í™œì„± ì‘ì—… ê´€ë¦¬
        function addToActiveTasks(taskId, data) {
            if (!activeTasks[taskId]) {
                activeTasks[taskId] = data || { status: "pending" };
                createTaskCard(taskId);
            } else if (data) {
                activeTasks[taskId] = data;
                updateTaskCard(taskId);
            }
        }
        
        // ì‘ì—… ì¹´ë“œ ìƒì„±
        function createTaskCard(taskId) {
            const tasksContainer = document.getElementById('tasksContainer');
            
            const card = document.createElement('div');
            card.id = `task-${taskId}`;
            card.className = 'task-card';
            card.innerHTML = `
                <h3>ì‘ì—… ID: ${taskId.substring(0, 8)}...</h3>
                <div class="task-status">ë¡œë”© ì¤‘...</div>
                <div class="task-progress"></div>
                <div class="task-actions">
                    <button class="view-task" data-id="${taskId}">ìƒì„¸ ë³´ê¸°</button>
                    <button class="cancel-task" data-id="${taskId}">ì‘ì—… ì·¨ì†Œ</button>
                </div>
            `;
            
            tasksContainer.appendChild(card);
            
            // ë²„íŠ¼ ì´ë²¤íŠ¸ ì—°ê²°
            card.querySelector('.view-task').addEventListener('click', () => {
                document.getElementById('taskId').value = taskId;
                document.getElementById('checkProgress').click();
            });
            
            card.querySelector('.cancel-task').addEventListener('click', async () => {
                document.getElementById('taskId').value = taskId;
                document.getElementById('cancelTask').click();
            });
            
            // ì‘ì—… ìƒíƒœ ì—…ë°ì´íŠ¸
            fetchTaskStatus(taskId);
        }
        
        // ì‘ì—… ì¹´ë“œ ì—…ë°ì´íŠ¸
        function updateTaskCard(taskId) {
            const card = document.getElementById(`task-${taskId}`);
            if (!card) return;
            
            const data = activeTasks[taskId];
            if (!data) return;
            
            const statusElement = card.querySelector('.task-status');
            const progressElement = card.querySelector('.task-progress');
            
            let statusClass = 'warning';
            if (data.status === "completed") statusClass = 'success';
            if (data.status === "failed" || data.status === "cancelled") statusClass = 'error';
            
            statusElement.innerHTML = `
                <p>ìƒíƒœ: <span class="${statusClass}">${data.status}</span></p>
                <p>ë©”ì‹œì§€: ${data.message || 'ì •ë³´ ì—†ìŒ'}</p>
            `;
            
            if (data.progress !== undefined) {
                progressElement.innerHTML = `
                    <div class="progress-bar">
                        <div class="progress-bar-fill" style="width: ${data.progress}%">${data.progress}%</div>
                    </div>
                `;
            }
            
            // ì™„ë£Œëœ ì‘ì—…ì€ ì·¨ì†Œ ë²„íŠ¼ ë¹„í™œì„±í™”
            if (data.status === "completed" || data.status === "failed" || data.status === "cancelled") {
                const cancelButton = card.querySelector('.cancel-task');
                if (cancelButton) {
                    cancelButton.disabled = true;
                }
            }
            
            // ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ ì¶”ê°€ (ì™„ë£Œëœ ê²½ìš°)
            if (data.status === "completed" && !card.querySelector('.download-buttons')) {
                const actionsElement = card.querySelector('.task-actions');
                const downloadButtons = document.createElement('div');
                downloadButtons.className = 'download-buttons';
                downloadButtons.innerHTML = `
                    <button class="download-audio" data-id="${taskId}">ì˜¤ë””ì˜¤ ë‹¤ìš´ë¡œë“œ</button>
                    <button class="download-result" data-id="${taskId}">ê²°ê³¼ ë‹¤ìš´ë¡œë“œ</button>
                `;
                actionsElement.appendChild(downloadButtons);
                
                // ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ ì´ë²¤íŠ¸ ì—°ê²°
                downloadButtons.querySelector('.download-audio').addEventListener('click', () => {
                    window.location.href = `${API_BASE_URL}/download/audio/${taskId}`;
                });
                
                downloadButtons.querySelector('.download-result').addEventListener('click', () => {
                    window.location.href = `${API_BASE_URL}/download/result/${taskId}`;
                });
            }
        }
        
        // ë‹¨ì¼ ì‘ì—… ìƒíƒœ ì—…ë°ì´íŠ¸
        function updateTaskState(taskId, data) {
            if (activeTasks[taskId]) {
                Object.assign(activeTasks[taskId], data);
                updateTaskCard(taskId);
            }
        }
        
        // ì‘ì—… ìƒíƒœ ê°€ì ¸ì˜¤ê¸°
        async function fetchTaskStatus(taskId) {
            try {
                const response = await fetch(`${API_BASE_URL}/progress/${taskId}`);
                const data = await response.json();
                
                if (data && !data.error) {
                    activeTasks[taskId] = data;
                    updateTaskCard(taskId);
                }
            } catch (error) {
                console.error(`ì‘ì—… ${taskId} ìƒíƒœ ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨:`, error);
            }
        }
        
        // ëª¨ë“  ì‘ì—… ì¹´ë“œ ì—…ë°ì´íŠ¸
        function updateAllTaskCards() {
            for (const taskId in activeTasks) {
                if (!document.getElementById(`task-${taskId}`)) {
                    createTaskCard(taskId);
                } else {
                    updateTaskCard(taskId);
                }
            }
        }
        
        // ìë™ ì—…ë°ì´íŠ¸ ì‹œì‘
        function startAutoUpdate() {
            if (!updateInterval) {
                updateInterval = setInterval(() => {
                    const taskIds = Object.keys(activeTasks);
                    if (taskIds.length === 0) {
                        clearInterval(updateInterval);
                        updateInterval = null;
                        return;
                    }
                    
                    // ì§„í–‰ ì¤‘ì¸ ì‘ì—…ë§Œ ì—…ë°ì´íŠ¸
                    taskIds.forEach(taskId => {
                        const task = activeTasks[taskId];
                        if (task && task.status !== "completed" && task.status !== "failed" && task.status !== "cancelled") {
                            fetchTaskStatus(taskId);
                        }
                    });
                }, 3000); // 3ì´ˆë§ˆë‹¤ ì—…ë°ì´íŠ¸
            }
        }
        
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì„œë²„ ìƒíƒœ í™•ì¸
        async function checkServerStatus() {
            try {
                const response = await fetch(`${API_BASE_URL}/health`);
                const data = await response.json();
                console.log('ì„œë²„ ìƒíƒœ:', data);
            } catch (error) {
                console.error('ì„œë²„ ì—°ê²° ì‹¤íŒ¨:', error);
                alert('ì„œë²„ì— ì—°ê²°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì„œë²„ê°€ ì‹¤í–‰ ì¤‘ì¸ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.');
            }
        }
        
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤í–‰
        window.addEventListener('load', () => {
            checkServerStatus();
        });
    </script>
</body>
</html>