name: AI Convert Service CI/CD

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Deploy to EC2
      uses: appleboy/ssh-action@v0.1.7
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USERNAME }}
        key: ${{ secrets.EC2_KEY }}
        script: |
          # AI Convert í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ë¡œ ì´ë™
          cd /home/ubuntu
          
          # ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì¤‘ì§€ ë° ì œê±°
          if [ -d "ai-convert" ]; then
            cd ai-convert
            sudo docker-compose down 2>/dev/null || true
            cd /home/ubuntu
          fi
          
          # ê¸°ì¡´ í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ ì œê±°
          sudo rm -rf ai-convert
          
          # ìµœì‹  ì½”ë“œ í´ë¡ 
          git clone https://github.com/godsaeng-tool/ai-convert.git ai-convert
          cd ai-convert
          
          # í™˜ê²½ë³€ìˆ˜ íŒŒì¼ ìƒì„±
          cat > .env << EOF
          GROQ_API_KEY=${{ secrets.GROQ_API_KEY }}
          GROQ_MODEL=${{ secrets.GROQ_MODEL }}
          BACKEND_URL=${{ secrets.BACKEND_URL }}
          WHISPER_MODEL=base
          EMBEDDING_MODEL=sentence-transformers/all-MiniLM-L6-v2
          EOF
          
          # Docker ì‹œìŠ¤í…œ ì •ë¦¬
          sudo docker system prune -f
          
          # Docker Composeë¡œ ë¹Œë“œ ë° ì‹¤í–‰
          echo "Building and starting containers..."
          sudo docker-compose up -d --build
          
          # ì»¨í…Œì´ë„ˆê°€ ì™„ì „ížˆ ì‹œìž‘ë  ë•Œê¹Œì§€ ëŒ€ê¸°
          echo "â³ Waiting for containers to start..."
          sleep 30
          
          # ì»¨í…Œì´ë„ˆ ìƒíƒœ í™•ì¸
          echo "Container status:"
          sudo docker-compose ps
          
          # ì»¨í…Œì´ë„ˆ ë¡œê·¸ í™•ì¸ (ìµœê·¼ 20ì¤„)
          echo "ðŸ“‹ Recent logs:"
          sudo docker-compose logs --tail=20 ai-convert-service
          
          # í–¥ìƒëœ í—¬ìŠ¤ì²´í¬ (ì—¬ëŸ¬ ë²ˆ ì‹œë„)
          echo "Health check attempts..."
          for i in {1..5}; do
            echo "Attempt $i/5:"
            if curl -f http://localhost:5000/health; then
              echo "âœ… Health check successful!"
              break
            else
              echo "âŒ Health check failed, retrying in 10 seconds..."
              sleep 10
            fi
          done
          
          # ìµœì¢… ìƒíƒœ í™•ì¸
          echo "Final deployment status:"
          sudo docker-compose ps
          
          echo "AI Convert deployment process completed!"
